version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@1.0.0

# commands:

jobs:
  build:
    docker:
      - image: cimg/node:14.15

    resource_class: xlarge
    working_directory: /mnt/ramdisk/project

    steps:
      - restore_cache:
          keys:
            - v1-project-{{ .Branch }}
            - v1-project-main

      - checkout

      - run:
          name: remove empty directories from the packages dir
          command: |
            find ./packages -mindepth 1 -maxdepth 1 -type d '!' -exec test -e "{}/package.json" ';' -print \
              | xargs --no-run-if-empty rm -r

      - run:
          # eslint will verify that the license header exists on the linted source files, this step is
          # to verify that other non-linted files also contains the license header (and therefore this is
          # in the 'build' job)
          name: verify that the license header is prepended to the non eslint'd source files
          command: build_utils/verify_license_header.sh

      - run: yarn config set ignore-engines true

      - run: yarn config set cache-folder /mnt/ramdisk/yarn-cache

        # Yarn has some random race-condition failures, trying multiple times seems to help
        # when the source of the problem is yarn itself and not the packages
      - run: yarn || yarn || yarn

      - run:
          # As a workaround to the --frozen-lockfile flag not working with workspaces
          # (see: https://github.com/yarnpkg/yarn/issues/4098)
          # we use a regular `yarn` and add an explicit test that the yarn.lock file is unchanged
          name: ensure yarn.lock file is up to date
          command: '! git diff --name-only | grep yarn.lock'

      - run:
          name: fix eslint cache
          command: yarn lerna exec ../../build_utils/fix_eslint_cache.sh

      - run: yarn build

      - persist_to_workspace:
          root: .
          paths:
            - '*'

  prettier:
    docker:
      - image: cimg/node:14.15

    steps:
      - attach_workspace:
          at: .

      - run:
          name: Run prettier
          command: yarn check-format --concurrency 2

  find_changed_packages:
    docker:
      - image: cimg/node:14.15
    resource_class: large

    steps:
      - attach_workspace:
          at: .
      - run:
          name: Compile and Run Find Changed Packages Script
          command: |
            pushd .circleci/scripts
            npm install
            node find_changed_packages
            popd
            for package in $(cat packages-to-test.txt); do
              echo "                - $package" >> config.yml
            done

      - persist_to_workspace:
          root: .
          paths:
            - config.yml
  

workflows:
  always-run:
    jobs:
      - build
      - find_changed_packages:
          requires:
            - build
      - prettier:
          requires:
            - build
      - continuation/continue:
          requires:
            - find_changed_packages
          configuration_path: .circleci/continue_config.yml