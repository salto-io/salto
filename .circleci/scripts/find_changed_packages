#! /usr/bin/env node

const { execSync } = require('child_process')
const { readFileSync, writeFileSync, existsSync, readdirSync } = require('fs')
const path = require('path')

function getChangedFiles() {
  const output = execSync('git log --name-status origin/main..HEAD').toString()
  return output
    .split('\n')
    .filter(line => line.startsWith('M') || line.startsWith('A') || line.startsWith('D'))
    .map(line => line.split('\t')[1])
    .filter(file => file && file.startsWith('packages/'))
}

// Fetch workspace info using `yarn workspaces info`
function fetchWorkspacesInfo() {
  const output = execSync('yarn workspaces info', { encoding: 'utf8' })
  const jsonOutput = output.substring(output.indexOf('{'), output.lastIndexOf('}') + 1)
  return JSON.parse(jsonOutput)
}

function resolveTransitiveDependencies(packageName, workspaceInfo, resolved, seen = new Set()) {
  if (seen.has(packageName)) {
    return
  }
  seen.add(packageName)

  const packageInfo = workspaceInfo[packageName]
  if (!packageInfo) {
    return
  }

  for (const dep of packageInfo.workspaceDependencies) {
    if (!resolved.has(dep)) {
      resolved.add(dep)
      resolveTransitiveDependencies(dep, workspaceInfo, resolved, seen)
    }
  }
}

function generateDependencyGraph(workspaceInfo) {
  const graph = {}

  for (const packageName of Object.keys(workspaceInfo)) {
    const resolvedDependencies = new Set()
    resolveTransitiveDependencies(packageName, workspaceInfo, resolvedDependencies)
    graph[packageName] = Array.from(resolvedDependencies)
  }

  return graph
}

function hasE2eTests(packageName) {
  const e2eDir = path.join(__dirname, '..', '..', 'packages', packageName, 'e2e_test')
  console.log('e2eDir:', e2eDir, 'exists:', existsSync(e2eDir))
  return existsSync(e2eDir) && readdirSync(e2eDir).some(file => file.endsWith('.test.ts'))
}

function hasUnitTests(packageName) {
  const utDir = path.join(__dirname, '..', '..', 'packages', packageName, 'test')
  console.log('utDir:', utDir, 'exists:', existsSync(utDir))
  return existsSync(utDir) && readdirSync(utDir).some(file => file.endsWith('.test.ts'))
}

function findChangedPackages() {
  const changedFiles = getChangedFiles()
  const changedPackages = new Set()

  for (const file of changedFiles) {
    const parts = file.split('/')
    if (parts.length > 1) {
      changedPackages.add('@salto-io/' + parts[1])
    }
  }

  return Array.from(changedPackages)
}

function main() {
  const changedPackages = findChangedPackages()
  console.log('Changed packages:', changedPackages)

  const dependencyGraph = generateDependencyGraph(fetchWorkspacesInfo())
  console.log('Dependency graph:', dependencyGraph)

  const packagesToTest = new Set()

  // if on main branch, run all tests
  if (process.env.CIRCLE_BRANCH === 'main') {
    console.log('Running all tests because we are on the main branch.')
    for (const pkg of dependencyGraph.keys()) {
      packagesToTest.add(pkg)
    }
  } else {
    // Otherwise, run tests for all changed packages and their dependencies
    for (const pkg of changedPackages) {
      packagesToTest.add(pkg)
      for (const dep of dependencyGraph[pkg]) {
        packagesToTest.add(dep)
      }
    }
  }

  // Add the list of packages to config.yml if necessary
  const configTemplatePath = path.join(__dirname, '..', 'config_template.yml')
  const continueConfigFilePath = path.join(__dirname, '..', 'continue_config.yml')
  const configTemplate = readFileSync(configTemplatePath, 'utf8')
  const packagesArray = Array.from(packagesToTest, pkg => pkg.replace('@salto-io/', '')).sort()
  const e2ePackagesToTest = []
  const unitPackagesToTest = []
  console.log('Packages to test:', packagesArray)
  for (pkg of packagesArray) {
    console.log('Package:', pkg)
    if (hasE2eTests(pkg)) {
      console.log('Package has e2e tests')
      e2ePackagesToTest.push(pkg)
    }
    if (hasUnitTests(pkg)) {
      console.log('Package has unit tests')
      unitPackagesToTest.push(pkg)
    }
  }
  const unitTestCoverage = `
  coverage_unittests:
    docker:
      - image: cimg/node:14.15

    steps:
      - attach_workspace:
          at: .

      - coveralls/upload:
          parallel_finished: true
          carryforward: "${unitPackagesToTest.join(' ')}"
`
  const e2eTestMatrix = `
      - test:
          requires:
            - build
          matrix:
            alias: test_e2e
            parameters:
              e2e_or_unittest:
                - e2e
              package_name:
                - ${e2ePackagesToTest.join('\n                - ')}`
    const unitTestMatrixAndCoverage = `
      - test:
          requires:
            - build
          matrix:
            alias: test_unittest
            parameters:
              e2e_or_unittest:
                - unittest
              package_name:
                - ${unitPackagesToTest.join('\n                - ')}
                
      - coverage_unittests:
          requires:
            - test_unittest
`

  let alteredConfigTemplate = e2ePackagesToTest.length > 0 ? configTemplate.replace(/# <NEEDS_E2E_TEST_REQUIREMENT>/g, '- test_e2e').replace(/# <TEST_MATRIX_E2E>/g, e2eTestMatrix) : configTemplate.replace(/# <NEEDS_E2E_TEST_REQUIREMENT>/g, '').replace(/# <TEST_MATRIX_E2E>/g, '')
  alteredConfigTemplate = unitPackagesToTest.length > 0 ? alteredConfigTemplate.replace(/# <NEEDS_UNITTEST_REQUIREMENT>/g, '- test_unittest').replace(/# <TEST_MATRIX_UNITTEST_AND_COVERAGE>/g, unitTestMatrixAndCoverage).replace(/# <UNITTESTS_COVERAGE>/g, unitTestCoverage) : alteredConfigTemplate.replace(/# <NEEDS_UNITTEST_REQUIREMENT>/g, '').replace(/# <TEST_MATRIX_UNITTEST_AND_COVERAGE>/g, '').replace(/# <UNITTESTS_COVERAGE>/g, '')
  
  writeFileSync(continueConfigFilePath, alteredConfigTemplate)
  console.log(alteredConfigTemplate)
  console.log(`Updated ${continueConfigFilePath} with packages to test: ${Array.from(packagesToTest).join(', ')}`)
}

main()
