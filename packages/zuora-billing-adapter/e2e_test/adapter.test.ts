/*
*                      Copyright 2022 Salto Labs Ltd.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with
* the License.  You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
import { isObjectType, FetchOptions } from '@salto-io/adapter-api'
import { CredsLease } from '@salto-io/e2e-credentials-store'
import { MockInterface } from '@salto-io/test-utils'
import { OAuthClientCredentials } from '../src/auth'
import { credsLease, realAdapter } from './adapter'
import ZuoraAdapter from '../src/adapter'

describe('Zuora adapter E2E with real swagger and mock replies', () => {
  let adapter: ZuoraAdapter
  let credLease: CredsLease<OAuthClientCredentials>

  jest.setTimeout(10 * 1000)

  beforeAll(async () => {
    credLease = await credsLease()
    const adapterAttr = realAdapter({ credentials: credLease.value })
    adapter = adapterAttr.adapter
  })

  afterAll(async () => {
    if (credLease.return) {
      await credLease.return()
    }
  })

  describe('fetch', () => {
    describe('swagger types only', () => {
      it('should generate the right type elements on fetch', async () => {
        const mockFetchOpts: MockInterface<FetchOptions> = {
          progressReporter: { reportProgress: jest.fn() },
        }
        const { elements } = await adapter.fetch(mockFetchOpts)

        expect(elements.every(isObjectType)).toBeTruthy()
        expect(elements.map(e => e.elemID.getFullName()).sort()).toEqual(expect.arrayContaining([
          'zuora_billing.AccountCreditCardHolder',
          'zuora_billing.AccountingCodeItem',
          'zuora_billing.AccountingCodes',
          'zuora_billing.AccountingPeriod',
          'zuora_billing.AccountingPeriod_fileIds',
          'zuora_billing.AccountingPeriods',
          'zuora_billing.BillToContact',
          'zuora_billing.BillingDocumentQueryResponseElementType',
          'zuora_billing.BillingUpdate',
          'zuora_billing.CatalogProduct',
          'zuora_billing.ChargeMetricsResponse',
          'zuora_billing.ChargeModelConfigurationType',
          'zuora_billing.ChargeModelDataOverride',
          'zuora_billing.ChargeModelDataOverride_chargeModelConfiguration',
          'zuora_billing.ChargeOverride',
          'zuora_billing.ChargeOverrideForEvergreen',
          'zuora_billing.ChargeTier',
          'zuora_billing.CreditMemoEntityPrefix',
          'zuora_billing.CustomObject',
          'zuora_billing.CustomObjectAllFieldsDefinition',
          'zuora_billing.CustomObjectAllFieldsDefinition_CreatedById',
          'zuora_billing.CustomObjectAllFieldsDefinition_CreatedDate',
          'zuora_billing.CustomObjectAllFieldsDefinition_Id',
          'zuora_billing.CustomObjectAllFieldsDefinition_UpdatedById',
          'zuora_billing.CustomObjectAllFieldsDefinition_UpdatedDate',
          'zuora_billing.CustomObjectCustomFieldDefinition',
          'zuora_billing.CustomObjectDefinition',
          'zuora_billing.CustomObjectDefinition_schema',
          'zuora_billing.CustomObjectDefinition_schema_relationships',
          'zuora_billing.CustomObjectDefinitions',
          'zuora_billing.CustomObjectRecordWithAllFields',
          'zuora_billing.DebitMemoEntityPrefix',
          'zuora_billing.DiscountPricingOverride',
          'zuora_billing.DiscountPricingUpdate',
          'zuora_billing.EndConditions',
          'zuora_billing.EventTrigger',
          'zuora_billing.EventTriggers',
          'zuora_billing.EventType',
          'zuora_billing.FieldsAdditionalProperties',
          'zuora_billing.FilterRuleParameterDefinition',
          'zuora_billing.FilterRuleParameterDefinitions',
          'zuora_billing.FilterRuleParameterValues',
          'zuora_billing.GETARPaymentType',
          'zuora_billing.GETARPaymentType_financeInformation',
          'zuora_billing.GETARPaymentTypewithSuccess',
          'zuora_billing.GETARPaymentTypewithSuccess_financeInformation',
          'zuora_billing.GETAccountType',
          'zuora_billing.GETAccountTypeBasicInfo',
          'zuora_billing.GETAccountTypeBillToContact',
          'zuora_billing.GETAccountTypeSoldToContact',
          'zuora_billing.GETAccountType_billingAndPayment',
          'zuora_billing.GETAccountType_metrics',
          'zuora_billing.GETAccountType_taxInfo',
          'zuora_billing.GETAccountingCodeItemType',
          'zuora_billing.GETAccountingPeriodType',
          'zuora_billing.GETAccountingPeriodType_fileIds',
          'zuora_billing.GETAttachmentResponseType',
          'zuora_billing.GETAttachmentResponseWithoutSuccessType',
          'zuora_billing.GETAttachmentsResponseType',
          'zuora_billing.GETBillingDocumentFilesDeletionJobResponse',
          'zuora_billing.GETBillingDocumentsResponseType',
          'zuora_billing.GETCMTaxItemType',
          'zuora_billing.GETCMTaxItemTypeNew',
          'zuora_billing.GETCMTaxItemTypeNew_financeInformation',
          'zuora_billing.GETCMTaxItemType_financeInformation',
          'zuora_billing.GETCalloutHistoryVOType',
          'zuora_billing.GETCalloutHistoryVOsType',
          'zuora_billing.GETChargeRSDetailType',
          'zuora_billing.GETCreditMemoCollectionType',
          'zuora_billing.GETCreditMemoItemPartType',
          'zuora_billing.GETCreditMemoItemPartTypewithSuccess',
          'zuora_billing.GETCreditMemoItemPartsCollectionType',
          'zuora_billing.GETCreditMemoItemType',
          'zuora_billing.GETCreditMemoItemType_financeInformation',
          'zuora_billing.GETCreditMemoItemType_taxationItems',
          'zuora_billing.GETCreditMemoItemTypewithSuccess',
          'zuora_billing.GETCreditMemoItemTypewithSuccess_financeInformation',
          'zuora_billing.GETCreditMemoItemTypewithSuccess_taxationItems',
          'zuora_billing.GETCreditMemoItemsListType',
          'zuora_billing.GETCreditMemoPartType',
          'zuora_billing.GETCreditMemoPartTypewithSuccess',
          'zuora_billing.GETCreditMemoPartsCollectionType',
          'zuora_billing.GETCreditMemoType',
          'zuora_billing.GETCreditMemoTypewithSuccess',
          'zuora_billing.GETCustomExchangeRatesDataType',
          'zuora_billing.GETCustomExchangeRatesDataType_DATE',
          'zuora_billing.GETCustomExchangeRatesType',
          'zuora_billing.GETDMTaxItemType',
          'zuora_billing.GETDMTaxItemTypeNew',
          'zuora_billing.GETDMTaxItemTypeNew_financeInformation',
          'zuora_billing.GETDMTaxItemType_financeInformation',
          'zuora_billing.GETDebitMemoCollectionType',
          'zuora_billing.GETDebitMemoItemCollectionType',
          'zuora_billing.GETDebitMemoItemType',
          'zuora_billing.GETDebitMemoItemType_financeInformation',
          'zuora_billing.GETDebitMemoItemType_taxationItems',
          'zuora_billing.GETDebitMemoItemTypewithSuccess',
          'zuora_billing.GETDebitMemoItemTypewithSuccess_financeInformation',
          'zuora_billing.GETDebitMemoItemTypewithSuccess_taxationItems',
          'zuora_billing.GETDebitMemoType',
          'zuora_billing.GETDebitMemoTypewithSuccess',
          'zuora_billing.GETDiscountApplyDetailsType',
          'zuora_billing.GETDocumentPropertiesResponseType',
          'zuora_billing.GETEmailHistoryVOType',
          'zuora_billing.GETEmailHistoryVOsType',
          'zuora_billing.GETEntitiesResponseType',
          'zuora_billing.GETEntitiesResponseTypeWithId',
          'zuora_billing.GETEntitiesType',
          'zuora_billing.GETEntitiesUserAccessibleResponseType',
          'zuora_billing.GETEntityConnectionsArrayItemsType',
          'zuora_billing.GETEntityConnectionsResponseType',
          'zuora_billing.GETInvoiceFileWrapper',
          'zuora_billing.GETInvoiceFilesResponse',
          'zuora_billing.GETInvoiceItemsResponse',
          'zuora_billing.GETInvoiceTaxItemType',
          'zuora_billing.GETInvoiceTaxationItemsResponse',
          'zuora_billing.GETInvoiceType',
          'zuora_billing.GETJournalEntriesInJournalRunType',
          'zuora_billing.GETJournalEntryDetailType',
          'zuora_billing.GETJournalEntryDetailTypeWithoutSuccess',
          'zuora_billing.GETJournalEntryItemType',
          'zuora_billing.GETJournalEntrySegmentType',
          'zuora_billing.GETJournalRunTransactionType',
          'zuora_billing.GETJournalRunType',
          'zuora_billing.GETMassUpdateType',
          'zuora_billing.GETPMAccountHolderInfo',
          'zuora_billing.GETPaidInvoicesType',
          'zuora_billing.GETPaymentItemPartCollectionType',
          'zuora_billing.GETPaymentItemPartType',
          'zuora_billing.GETPaymentItemPartTypewithSuccess',
          'zuora_billing.GETPaymentMethodResponse',
          'zuora_billing.GETPaymentMethodType',
          'zuora_billing.GETPaymentMethodType_cardHolderInfo',
          'zuora_billing.GETPaymentMethodsType',
          'zuora_billing.GETPaymentPartType',
          'zuora_billing.GETPaymentPartTypewithSuccess',
          'zuora_billing.GETPaymentPartsCollectionType',
          'zuora_billing.GETPaymentRunCollectionType',
          'zuora_billing.GETPaymentRunDataArrayResponse',
          'zuora_billing.GETPaymentRunDataElementResponse',
          'zuora_billing.GETPaymentRunDataTransactionElementResponse',
          'zuora_billing.GETPaymentRunSummaryResponse',
          'zuora_billing.GETPaymentRunSummaryTotalValues',
          'zuora_billing.GETPaymentRunType',
          'zuora_billing.GETPaymentType',
          'zuora_billing.GETPaymentsType',
          'zuora_billing.GETProductDiscountApplyDetailsType',
          'zuora_billing.GETProductRatePlanChargePricingTierType',
          'zuora_billing.GETProductRatePlanChargePricingType',
          'zuora_billing.GETProductRatePlanChargeType',
          'zuora_billing.GETProductRatePlanChargeType_financeInformation',
          'zuora_billing.GETProductRatePlansResponse',
          'zuora_billing.GETRSDetailForProductChargeType',
          'zuora_billing.GETRSDetailType',
          'zuora_billing.GETRSDetailWithoutSuccessType',
          'zuora_billing.GETRSDetailsByChargeType',
          'zuora_billing.GETRSDetailsByProductChargeType',
          'zuora_billing.GETRampByRampNumberResponseType',
          'zuora_billing.GETRampByRampNumberResponseType_reasons',
          'zuora_billing.GETRampMetricsByOrderNumberResponseType',
          'zuora_billing.GETRampMetricsByOrderNumberResponseType_reasons',
          'zuora_billing.GETRampMetricsByRampNumberResponseType',
          'zuora_billing.GETRampMetricsByRampNumberResponseType_reasons',
          'zuora_billing.GETRampMetricsBySubscriptionKeyResponseType',
          'zuora_billing.GETRampMetricsBySubscriptionKeyResponseType_reasons',
          'zuora_billing.GETRampsBySubscriptionKeyResponseType',
          'zuora_billing.GETRampsBySubscriptionKeyResponseType_reasons',
          'zuora_billing.GETRefundCollectionType',
          'zuora_billing.GETRefundItemPartCollectionType',
          'zuora_billing.GETRefundItemPartType',
          'zuora_billing.GETRefundItemPartTypewithSuccess',
          'zuora_billing.GETRefundPartCollectionType',
          'zuora_billing.GETRefundType',
          'zuora_billing.GETRefundType_financeInformation',
          'zuora_billing.GETRefundTypewithSuccess',
          'zuora_billing.GETRefundTypewithSuccess_financeInformation',
          'zuora_billing.GETRevenueEventDetailType',
          'zuora_billing.GETRevenueEventDetailWithoutSuccessType',
          'zuora_billing.GETRevenueEventDetailsType',
          'zuora_billing.GETRevenueItemType',
          'zuora_billing.GETRevenueItemTypeResponse',
          'zuora_billing.GETRevenueItemsType',
          'zuora_billing.GETRevenueRecognitionRuleAssociationType',
          'zuora_billing.GETRevenueStartDateSettingType',
          'zuora_billing.GETRsRevenueItemType',
          'zuora_billing.GETRsRevenueItemsType',
          'zuora_billing.GETSubscriptionProductFeatureType',
          'zuora_billing.GETSubscriptionRatePlanChargesType',
          'zuora_billing.GETSubscriptionRatePlanType',
          'zuora_billing.GETSubscriptionType',
          'zuora_billing.GETSubscriptionTypeWithSuccess',
          'zuora_billing.GETSubscriptionWrapper',
          'zuora_billing.GETTaxationItemType',
          'zuora_billing.GETTaxationItemType_financeInformation',
          'zuora_billing.GETTaxationItemsOfCreditMemoItemType',
          'zuora_billing.GETTaxationItemsOfDebitMemoItemType',
          'zuora_billing.GETTierType',
          'zuora_billing.GETUsageType',
          'zuora_billing.GETUsageWrapper',
          'zuora_billing.GetAllOrdersResponseType',
          'zuora_billing.GetBillingPreviewRunResponse',
          'zuora_billing.GetDataQueryJobResponse',
          'zuora_billing.GetDataQueryJobsResponse',
          'zuora_billing.GetDebitMemoApplicationPartCollectionType',
          'zuora_billing.GetDebitMemoApplicationPartType',
          'zuora_billing.GetInvoiceApplicationPartCollectionType',
          'zuora_billing.GetInvoiceApplicationPartType',
          'zuora_billing.GetOrderResponse',
          'zuora_billing.GetOrderResponseForEvergreen',
          'zuora_billing.GetOrderResponseForEvergreen_reasons',
          'zuora_billing.GetOrderResponse_reasons',
          'zuora_billing.GetOrderResume',
          'zuora_billing.GetOrderSuspend',
          'zuora_billing.GetOrdersResponse',
          'zuora_billing.GetOrdersResponse_reasons',
          'zuora_billing.GetProductFeatureType',
          'zuora_billing.GetStoredCredentialProfilesResponse',
          'zuora_billing.GetStoredCredentialProfilesResponse_profiles',
          'zuora_billing.GetSubscriptionTermInfoResponseType',
          'zuora_billing.GetSubscriptionTermInfoResponseType_reasons',
          'zuora_billing.GetWorkflowResponse',
          'zuora_billing.GetWorkflowResponse_tasks',
          'zuora_billing.HostedPage',
          'zuora_billing.HostedPages',
          'zuora_billing.InitialTerm',
          'zuora_billing.InvoiceEntityPrefix',
          'zuora_billing.InvoiceFile',
          'zuora_billing.InvoiceItem',
          'zuora_billing.InvoiceItem_taxationItems',
          'zuora_billing.JobResult',
          'zuora_billing.JobResult_reasons',
          'zuora_billing.JobResult_subscriptions',
          'zuora_billing.Linkage',
          'zuora_billing.ListAllSettings',
          'zuora_billing.NotificationDefinitions',
          'zuora_billing.NotificationEmailTemplates',
          'zuora_billing.NotificationsHistoryDeletionTaskResponse',
          'zuora_billing.OneTimeFlatFeePricingOverride',
          'zuora_billing.OneTimePerUnitPricingOverride',
          'zuora_billing.OneTimeTieredPricingOverride',
          'zuora_billing.OneTimeVolumePricingOverride',
          'zuora_billing.Order',
          'zuora_billing.OrderAction',
          'zuora_billing.OrderActionForEvergreen',
          'zuora_billing.OrderActionObjectCustomFields',
          'zuora_billing.OrderForEvergreen',
          'zuora_billing.OrderForEvergreen_subscriptions',
          'zuora_billing.OrderItem',
          'zuora_billing.OrderMetricsForEvergreen',
          'zuora_billing.OrderObjectCustomFields',
          'zuora_billing.OrderRampIntervalMetrics',
          'zuora_billing.OrderRampMetrics',
          'zuora_billing.Order_subscriptions',
          'zuora_billing.OwnerTransfer',
          'zuora_billing.POSTPMMandateInfo',
          'zuora_billing.PaymentCollectionResponseType',
          'zuora_billing.PaymentEntityPrefix',
          'zuora_billing.PaymentGateways',
          'zuora_billing.PaymentMethod',
          'zuora_billing.PaymentMethod_accountHolderInfo',
          'zuora_billing.PricingUpdate',
          'zuora_billing.PricingUpdateForEvergreen',
          'zuora_billing.ProductRatePlanType',
          'zuora_billing.ProductType',
          'zuora_billing.ProxyGetAccount',
          'zuora_billing.ProxyGetAmendment',
          'zuora_billing.ProxyGetBillRun',
          'zuora_billing.ProxyGetCommunicationProfile',
          'zuora_billing.ProxyGetContact',
          'zuora_billing.ProxyGetCreditBalanceAdjustment',
          'zuora_billing.ProxyGetExport',
          'zuora_billing.ProxyGetFeature',
          'zuora_billing.ProxyGetImport',
          'zuora_billing.ProxyGetInvoice',
          'zuora_billing.ProxyGetInvoiceAdjustment',
          'zuora_billing.ProxyGetInvoiceItem',
          'zuora_billing.ProxyGetInvoiceItemAdjustment',
          'zuora_billing.ProxyGetInvoicePayment',
          'zuora_billing.ProxyGetInvoiceSplit',
          'zuora_billing.ProxyGetInvoiceSplitItem',
          'zuora_billing.ProxyGetPayment',
          'zuora_billing.ProxyGetPaymentMethod',
          'zuora_billing.ProxyGetPaymentMethodSnapshot',
          'zuora_billing.ProxyGetPaymentMethodTransactionLog',
          'zuora_billing.ProxyGetPaymentTransactionLog',
          'zuora_billing.ProxyGetProduct',
          'zuora_billing.ProxyGetProductFeature',
          'zuora_billing.ProxyGetProductRatePlan',
          'zuora_billing.ProxyGetProductRatePlanCharge',
          'zuora_billing.ProxyGetProductRatePlanChargeTier',
          'zuora_billing.ProxyGetRatePlan',
          'zuora_billing.ProxyGetRatePlanCharge',
          'zuora_billing.ProxyGetRatePlanChargeTier',
          'zuora_billing.ProxyGetRefund',
          'zuora_billing.ProxyGetRefundInvoicePayment',
          'zuora_billing.ProxyGetRefundTransactionLog',
          'zuora_billing.ProxyGetSubscription',
          'zuora_billing.ProxyGetSubscriptionProductFeature',
          'zuora_billing.ProxyGetTaxationItem',
          'zuora_billing.ProxyGetUnitOfMeasure',
          'zuora_billing.ProxyGetUsage',
          'zuora_billing.PublicEmailTemplate',
          'zuora_billing.PublicNotificationDefinition',
          'zuora_billing.PublicNotificationDefinition_callout',
          'zuora_billing.PublicNotificationDefinition_filterRule',
          'zuora_billing.QueryCustomObjectRecordsResponse',
          'zuora_billing.QuoteObjectFields',
          'zuora_billing.RampChargeResponse',
          'zuora_billing.RampIntervalChargeDeltaMetrics',
          'zuora_billing.RampIntervalChargeDeltaMetrics_deltaMrr',
          'zuora_billing.RampIntervalChargeDeltaMetrics_deltaQuantity',
          'zuora_billing.RampIntervalChargeMetrics',
          'zuora_billing.RampIntervalChargeMetrics_mrr',
          'zuora_billing.RampIntervalMetrics',
          'zuora_billing.RampIntervalResponse',
          'zuora_billing.RampMetrics',
          'zuora_billing.RampResponse',
          'zuora_billing.RatePlanChargeObjectCustomFields',
          'zuora_billing.RatePlanObjectCustomFields',
          'zuora_billing.RatePlanOverride',
          'zuora_billing.RatePlanOverrideForEvergreen',
          'zuora_billing.RatePlanUpdate',
          'zuora_billing.RatePlanUpdateForEvergreen',
          'zuora_billing.RecurringFlatFeePricingOverride',
          'zuora_billing.RecurringFlatFeePricingUpdate',
          'zuora_billing.RecurringPerUnitPricingOverride',
          'zuora_billing.RecurringPerUnitPricingUpdate',
          'zuora_billing.RecurringTieredPricingOverride',
          'zuora_billing.RecurringTieredPricingUpdate',
          'zuora_billing.RecurringVolumePricingOverride',
          'zuora_billing.RecurringVolumePricingUpdate',
          'zuora_billing.RefundEntityPrefix',
          'zuora_billing.RefundPartResponseType',
          'zuora_billing.RefundPartResponseTypewithSuccess',
          'zuora_billing.RenewalTerm',
          'zuora_billing.SequenceSet',
          'zuora_billing.SequenceSets',
          'zuora_billing.SettingItemHttpOperation',
          'zuora_billing.SettingItemHttpRequestParameter',
          'zuora_billing.SettingItemWithOperationsInformation',
          'zuora_billing.SoldToContact',
          'zuora_billing.StandardObject',
          'zuora_billing.SubscriptionObjectCustomFields',
          'zuora_billing.Task',
          'zuora_billing.TasksResponse',
          'zuora_billing.TasksResponse_pagination',
          'zuora_billing.TaxInfo',
          'zuora_billing.Term',
          'zuora_billing.TermsAndConditions',
          'zuora_billing.TimeSlicedElpNetMetrics',
          'zuora_billing.TimeSlicedMetrics',
          'zuora_billing.TimeSlicedMetricsForEvergreen',
          'zuora_billing.TimeSlicedNetMetrics',
          'zuora_billing.TimeSlicedNetMetricsForEvergreen',
          'zuora_billing.TimeSlicedTcbNetMetrics',
          'zuora_billing.TimeSlicedTcbNetMetricsForEvergreen',
          'zuora_billing.TriggerDate',
          'zuora_billing.TriggerParams',
          'zuora_billing.Usage',
          'zuora_billing.UsageFlatFeePricingOverride',
          'zuora_billing.UsageFlatFeePricingUpdate',
          'zuora_billing.UsageOveragePricingOverride',
          'zuora_billing.UsageOveragePricingUpdate',
          'zuora_billing.UsagePerUnitPricingOverride',
          'zuora_billing.UsagePerUnitPricingUpdate',
          'zuora_billing.UsageTieredPricingOverride',
          'zuora_billing.UsageTieredPricingUpdate',
          'zuora_billing.UsageTieredWithOveragePricingOverride',
          'zuora_billing.UsageTieredWithOveragePricingUpdate',
          'zuora_billing.UsageVolumePricingOverride',
          'zuora_billing.UsageVolumePricingUpdate',
          'zuora_billing.Usage_values',
          'zuora_billing.UsagesResponse',
          'zuora_billing.Workflow',
          'zuora_billing.WorkflowExport',
          'zuora_billing.Workflows',
          'zuora_billing.Workflows_pagination',
          'zuora_billing.creditCard',
          'zuora_billing.orderMetric',
        ]))
      })
    })
  })
})
